name: Sync Brand Assets (Polling)

on:
  schedule:
    # Run daily at 8:00 UTC
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  check-and-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Website
        uses: actions/checkout@v4

      - name: Check for Updates
        id: check
        env:
          GH_TOKEN: ${{ secrets.BRAND_REPO_READ_TOKEN }}
        run: |
          # 1. Get Local Version
          LOCAL_VERSION=$(jq -r .version src/data/brand-version.json)
          echo "Current local version: $LOCAL_VERSION"

          # 2. Get Remote Version (Latest Release Tag)
          # We use the GitHub CLI to fetch the latest release tag from the brand repo
          REMOTE_VERSION=$(gh release view --repo bitcraft-apps/bitcraft-brand --json tagName -q .tagName)
          echo "Latest remote version: $REMOTE_VERSION"

          # 3. Compare
          # Normalize versions by removing leading 'v' if present
          LOCAL_CLEAN=${LOCAL_VERSION#v}
          REMOTE_CLEAN=${REMOTE_VERSION#v}

          echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT

          if [ "$LOCAL_CLEAN" == "$REMOTE_CLEAN" ]; then
            echo "Versions match. No update needed."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            echo "New version found!"
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "version=$REMOTE_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Download & Update Assets
        if: steps.check.outputs.update_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.BRAND_REPO_READ_TOKEN }}
          VERSION: ${{ steps.check.outputs.version }}
        run: |
          echo "Downloading assets for version $VERSION..."

          # Download the bundle zip from the release
          gh release download "$VERSION" \
            --repo bitcraft-apps/bitcraft-brand \
            --pattern "*brand-bundle*.zip" \
            --dir temp-download

          # Find the downloaded zip file
          ZIP_FILE=$(ls temp-download/*.zip)
          echo "Downloaded: $ZIP_FILE"

          # Prepare destination
          rm -rf public/brand
          mkdir -p public/brand

          # Unzip to a temporary directory
          unzip -o "$ZIP_FILE" -d temp-unzip

          # The bundle structure is:
          # bundle/
          #   favicon-16x16.png, favicon-32x32.png, ... (standard files)
          #   brand/
          #     bitcraft-og.png
          #     tokens.css
          #     logo/ (future: logo SVGs)

          # Move contents of 'bundle' directory to repo root (temporary)
          cp -R temp-unzip/bundle/* .

          # 1. Move standard web assets to public/ root
          find . -maxdepth 1 -type f \( -name "favicon*" -o -name "android-chrome*" -o -name "apple-touch-icon.png" -o -name "site.webmanifest" \) -exec mv -f {} public/ \;

          # 2. Handle brand/ subdirectory
          if [ -d "brand" ]; then
             mkdir -p public/brand src/styles

             # Move tokens.css to src/styles/
             if [ -f "brand/tokens.css" ]; then
                mv -f brand/tokens.css src/styles/
             fi

             # Copy remaining brand assets to public/brand/
             cp -R brand/* public/brand/
             rm -rf brand
          fi

          # Clean up temp directories
          rm -rf temp-download temp-unzip

          # Update the local version file
          jq --arg v "$VERSION" '.version = $v' src/data/brand-version.json > temp.json && mv temp.json src/data/brand-version.json

      - name: Create Pull Request
        if: steps.check.outputs.update_needed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(brand): update assets to ${{ steps.check.outputs.version }}'
          branch: brand-update-${{ steps.check.outputs.version }}
          title: 'chore(brand): update assets to ${{ steps.check.outputs.version }}'
          body: |
            Automated brand asset update detected.

            **Old Version:** ${{ steps.check.outputs.local_version }} (implied)
            **New Version:** ${{ steps.check.outputs.version }}

            This PR was created automatically by the polling workflow.
          delete-branch: true
